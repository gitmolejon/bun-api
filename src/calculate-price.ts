import Database from 'bun:sqlite';
import {
    Parameters,
    Airport,
    Coordinates,
    Island,
    ZoneLevel,
    CardinalPoint,
    Constants,
    DayTime,
    ServiceType,
    VehicleType
} from './types';

import {
    calculateZoneLevel,
    calculateNearestAirport,
    calculateKilometersBetweenPoints,
    calculateCustomRoute,
    calculateDayTime,
    calculateIsLuxury,
    calculateReducedKMH,
    calculateAtDisposalPrice,
    calculateModelPrice,
    calculatePriceLuggage,
    calculateIslandFromCoordinates,
    isPointInAnyPolygon,
    isAirportCloseToCoordinates,
    isPlaceSuitableForShuttle,
    getIslandsPlacesForShuttle,
    getAirportsPricesForShuttle,
    calculateIsAdapted,
    calculatePricesWithTresholds,
    calculatePriceLuggageManipulation,
    calculateTaxes,
} from './utils';


const MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA: number = 15;

export const AIRPORT_COORDINATES: { [key in Airport]: Coordinates } = {
    // FIRST AIRPORTS:
    // [Airport.VDE]: [27.814847, -17.887056],
    // [Airport.SPC]: [28.626478, -17.755611],
    // [Airport.GMZ]: [28.029722, -17.214167],
    // [Airport.TFN]: [28.4845157,-16.3459953],
    // [Airport.TFS]: [28.044475, -16.572488],
    // [Airport.LPA]: [27.931886, -15.386586],
    // [Airport.ACE]: [28.945464, -13.605225],
    // [Airport.FUE]: [28.452717, -13.863761],
    // UPDATED AIRPORTS:
    [Airport.VDE]: [27.814847, -17.887056],
    [Airport.SPC]: [28.62564952005458, -17.75511236939051],
    [Airport.GMZ]: [28.029722, -17.214167],
    [Airport.TFN]: [28.48417803442812, -16.343086783604285],
    [Airport.TFS]: [28.046500116877535, -16.572706413129964],
    [Airport.LPA]: [27.929358992871467, -15.387152452894108],
    [Airport.ACE]: [28.951544001195842, -13.606755084401644],
    [Airport.FUE]: [28.447717772134673, -13.866626767517285],
};

const HARD_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -16.783544733028805,
            28.382143927591457
        ],
        [
            -16.83350369272938,
            28.40003662422528
        ],
        [
            -16.9365810860306,
            28.356081202484134
        ],
        [
            -16.869432223081418,
            28.29099631769884
        ],
        [
            -16.795810823183416,
            28.3038266758316
        ],
        [
            -16.777655987904637,
            28.32457604350094
        ],
        [
            -16.79044315490131,
            28.36376190928945
        ],
        [
            -16.783544733028805,
            28.382143927591457
        ]
    ],
    [
        [
            -15.709691554744353,
            28.036402576349516
        ],
        [
            -15.764014759554485,
            28.05949752698529
        ],
        [
            -15.818439910390452,
            28.01873765376763
        ],
        [
            -15.840958230769786,
            27.9616085943332
        ],
        [
            -15.809566964663247,
            27.860234151823178
        ],
        [
            -15.752058581147594,
            27.91437181446566
        ],
        [
            -15.723992776010334,
            27.94265605600195
        ],
        [
            -15.71092395482544,
            27.94409661170475
        ],
        [
            -15.666737702701507,
            27.941469570670186
        ],
        [
            -15.63339954662409,
            27.906191543684553
        ],
        [
            -15.580725769378347,
            27.89288266467819
        ],
        [
            -15.553208840342052,
            27.938063499546658
        ],
        [
            -15.543596503297408,
            28.00322501681817
        ],
        [
            -15.561152180389797,
            28.015506834386425
        ],
        [
            -15.57936294578559,
            28.029273392306322
        ],
        [
            -15.599141238473464,
            28.043159652049496
        ],
        [
            -15.648271330532339,
            28.06651144729451
        ],
        [
            -15.709691554744353,
            28.036402576349516
        ]
    ],
    [
        [
            -16.31796931952661,
            28.584415494463713
        ],
        [
            -16.356844751125863,
            28.554594466443504
        ],
        [
            -16.353453135992936,
            28.542859552251016
        ],
        [
            -16.34743579064346,
            28.541323771029596
        ],
        [
            -16.280381031530737,
            28.520736737256
        ],
        [
            -16.233034177059864,
            28.504677022903692
        ],
        [
            -16.16292302256923,
            28.527253112721993
        ],
        [
            -16.15929563200075,
            28.517199576808224
        ],
        [
            -16.111813456024606,
            28.542128627976524
        ],
        [
            -16.13026311622008,
            28.595528662194766
        ],
        [
            -16.190609287076114,
            28.58686809187789
        ],
        [
            -16.31796931952661,
            28.584415494463713
        ]
    ],
    [
        [
            -14.183786244273449,
            28.34584242653837
        ],
        [
            -14.176539044338597,
            28.33862940024244
        ],
        [
            -14.147015576867375,
            28.369454632841624
        ],
        [
            -14.10259122454994,
            28.429313615713497
        ],
        [
            -14.071300225749908,
            28.479187549404443
        ],
        [
            -14.02573464687245,
            28.55966875422034
        ],
        [
            -14.009568164773043,
            28.653831745470214
        ],
        [
            -14.022609103836032,
            28.656692669502277
        ],
        [
            -14.166683226073133,
            28.412108356587837
        ],
        [
            -14.183786244273449,
            28.34584242653837
        ]
    ],
    [
        [
            -17.928549765612132,
            28.855638227492648
        ],
        [
            -17.977732511799246,
            28.82650172883858
        ],
        [
            -17.933524872353075,
            28.77569857209464
        ],
        [
            -17.879637406159503,
            28.70492990726831
        ],
        [
            -17.80027032033925,
            28.7121674132748
        ],
        [
            -17.788629388890826,
            28.754096016545887
        ],
        [
            -17.84587782465597,
            28.81515357056165
        ],
        [
            -17.864904480088967,
            28.84708806327989
        ],
        [
            -17.928549765612132,
            28.855638227492648
        ]
    ]
];

const VERY_HARD_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -16.784900008744557,
            28.27234712173977
        ],
        [
            -16.729286538097583,
            28.201622806853692
        ],
        [
            -16.677546955705026,
            28.179954504036047
        ],
        [
            -16.646708682673307,
            28.179020208925618
        ],
        [
            -16.597431947502002,
            28.22582283618994
        ],
        [
            -16.530024367100793,
            28.2864923828934
        ],
        [
            -16.47399916374019,
            28.306803239293494
        ],
        [
            -16.446164085275143,
            28.362616378354232
        ],
        [
            -16.523027587190853,
            28.35363446637001
        ],
        [
            -16.756111364570415,
            28.305024532056194
        ],
        [
            -16.784900008744557,
            28.27234712173977
        ]
    ]
];

const SHUTTLE_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -16.701147270783792,
            27.997219656982864
        ],
        [
            -16.639192874496445,
            27.999483020392688
        ],
        [
            -16.528140210484736,
            28.02274149280838
        ],
        [
            -16.50857538069019,
            28.059441199556687
        ],
        [
            -16.5346943895363,
            28.091522003012912
        ],
        [
            -16.652681016776427,
            28.055736121871576
        ],
        [
            -16.67629092173317,
            28.056314884658903
        ],
        [
            -16.69534993993895,
            28.0463138255343
        ],
        [
            -16.723625707753,
            28.030645679403207
        ],
        [
            -16.701147270783792,
            27.997219656982864
        ]
    ],
    [
        [
            -13.469788538386439,
            29.001945199600584
        ],
        [
            -13.491990446012466,
            29.01931760392749
        ],
        [
            -13.548089142709763,
            29.021644356085094
        ],
        [
            -13.5795508950835,
            28.98777498546584
        ],
        [
            -13.62023231903671,
            28.979490955901365
        ],
        [
            -13.661799114586472,
            28.965657405113248
        ],
        [
            -13.890799924681346,
            28.864311102600723
        ],
        [
            -13.792034518819008,
            28.83107779100021
        ],
        [
            -13.586268156294892,
            28.922230024152256
        ],
        [
            -13.469788538386439,
            29.001945199600584
        ]
    ],
    [
        [
            -13.871998660241587,
            28.745161648162508
        ],
        [
            -13.897286957071202,
            28.72556630981778
        ],
        [
            -13.878161288757923,
            28.7065442152866
        ],
        [
            -13.862247538658607,
            28.703438723015225
        ],
        [
            -13.865939456646885,
            28.72314012967513
        ],
        [
            -13.843320879137252,
            28.72585727382321
        ],
        [
            -13.866174251793552,
            28.75057114072436
        ],
        [
            -13.871998660241587,
            28.745161648162508
        ]
    ],
    [
        [
            -13.890189526231524,
            28.53477274079522
        ],
        [
            -13.896321358994214,
            28.498271555744296
        ],
        [
            -13.894587705049986,
            28.35776813754555
        ],
        [
            -13.866884210717245,
            28.34653695911865
        ],
        [
            -13.838466150894646,
            28.41467930494079
        ],
        [
            -13.829954271280116,
            28.54811081082363
        ],
        [
            -13.890189526231524,
            28.53477274079522
        ]
    ],
    [
        [
            -14.226383478285811,
            28.179334256160615
        ],
        [
            -14.36005016990751,
            28.069055235299558
        ],
        [
            -14.36823789743201,
            28.047710161898365
        ],
        [
            -14.328647952948074,
            28.03777417494622
        ],
        [
            -14.262710265700207,
            28.100055978790152
        ],
        [
            -14.142862005527661,
            28.18716105253874
        ],
        [
            -14.156068847839421,
            28.196784281821323
        ],
        [
            -14.207672851957028,
            28.178841934802605
        ],
        [
            -14.226383478285811,
            28.179334256160615
        ]
    ],
    [
        [
            -15.43398273775972,
            28.15679051085658
        ],
        [
            -15.519644446359308,
            28.14889915691535
        ],
        [
            -15.532944482467798,
            28.115221712022475
        ],
        [
            -15.459851512950635,
            28.061239262532574
        ],
        [
            -15.425220073381787,
            28.01841518792585
        ],
        [
            -15.384467326963716,
            28.023495590746137
        ],
        [
            -15.39305237423585,
            28.155888340882854
        ],
        [
            -15.403626051479279,
            28.169319863194815
        ],
        [
            -15.43398273775972,
            28.15679051085658
        ]
    ],
    [
        [
            -15.748812018771304,
            27.84873350360448
        ],
        [
            -15.770788499479437,
            27.81788012196951
        ],
        [
            -15.670299421253844,
            27.742152880072453
        ],
        [
            -15.571134075557723,
            27.735672058646998
        ],
        [
            -15.423155439200343,
            27.804863290724086
        ],
        [
            -15.46176645553578,
            27.82509050188427
        ],
        [
            -15.499589248816761,
            27.79775756614292
        ],
        [
            -15.611217504481175,
            27.79996022340066
        ],
        [
            -15.693245333624333,
            27.815560782932593
        ],
        [
            -15.748812018771304,
            27.84873350360448
        ]
    ],
    [
        [
         -16.752600532953807,
         28.09627225947021
        ],
        [
         -16.73968404037518,
         28.053021911545116
        ],
        [
         -16.730955143897546,
         28.05053087902266
        ],
        [
         -16.725783524966346,
         28.050223976279696
        ],
        [
         -16.721787309958216,
         28.04659961782771
        ],
        [
         -16.71030313544722,
         28.038114611080417
        ],
        [
         -16.6996215272072,
         28.043985547327026
        ],
        [
         -16.70403026641233,
         28.096452132189654
        ],
        [
         -16.731931124038596,
         28.11105118749967
        ],
        [
         -16.752600532953807,
         28.09627225947021
        ]
      ],
      [
        [
          -17.74773356005531,
          28.707401837814885
        ],
        [
          -17.796779727925923,
          28.70022206020944
        ],
        [
          -17.79635717375021,
          28.59273625499523
        ],
        [
          -17.732631090166194,
          28.59246463190952
        ],
        [
          -17.74773356005531,
          28.707401837814885
        ]
      ]
];

const LUGGAGE_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
          -14.363073210166846,
          28.053070596258095
        ],
        [
          -14.365230021892756,
          28.051624150922663
        ],
        [
          -14.364647545107488,
          28.048331402631376
        ],
        [
          -14.359940502978333,
          28.046358484044532
        ],
        [
          -14.356666039263132,
          28.049039977505856
        ],
        [
          -14.357733775816001,
          28.05027329516888
        ],
        [
          -14.363073210166846,
          28.053070596258095
        ]
      ],
      [
        [
          -16.588751629975917,
          28.046724483770703
        ],
        [
          -16.594336838393247,
          28.038963168175215
        ],
        [
          -16.590296474857126,
          28.033823610495247
        ],
        [
          -16.552150689708384,
          28.047563511370242
        ],
        [
          -16.562132764327032,
          28.056163166835518
        ],
        [
          -16.57770865000107,
          28.054213311163664
        ],
        [
          -16.588751629975917,
          28.046724483770703
        ]
      ],
      [
        [
          -16.35902012894647,
          28.489251343908364
        ],
        [
          -16.358145513136094,
          28.48683713814158
        ],
        [
          -16.324986291719,
          28.475725826073585
        ],
        [
          -16.324579973986886,
          28.478624148284297
        ],
        [
          -16.328349300775784,
          28.48001430818242
        ],
        [
          -16.340312688830224,
          28.483696958199637
        ],
        [
          -16.34004345948253,
          28.485977357929116
        ],
        [
          -16.34389535410753,
          28.487309819031168
        ],
        [
          -16.345612050301412,
          28.48911573243207
        ],
        [
          -16.35902012894647,
          28.489251343908364
        ]
      ],
      [
        [
          -13.45377938543075,
          29.224003709053278
        ],
        [
          -13.453819004611006,
          29.223507065635417
        ],
        [
          -13.45258360653068,
          29.223425339272765
        ],
        [
          -13.452263051342726,
          29.2231235798301
        ],
        [
          -13.451542702608037,
          29.223991135832506
        ],
        [
          -13.45377938543075,
          29.224003709053278
        ]
      ],
      [
        [
          -13.525006216589475,
          28.974005942181066
        ],
        [
          -13.529784214569219,
          28.973739091428868
        ],
        [
          -13.537156982473988,
          28.9662988855697
        ],
        [
          -13.530189793419964,
          28.96001797487537
        ],
        [
          -13.523133967581316,
          28.96969713302947
        ],
        [
          -13.525006216589475,
          28.974005942181066
        ]
      ],
      [
        [
          -16.249578864845603,
          28.45881603126891
        ],
        [
          -16.24615642200311,
          28.454765341808482
        ],
        [
          -16.239414646480753,
          28.471901113845178
        ],
        [
          -16.242116982789412,
          28.473156723304896
        ],
        [
          -16.24708485555928,
          28.470744637365442
        ],
        [
          -16.245994956652822,
          28.46721194446367
        ],
        [
          -16.249578864845603,
          28.45881603126891
        ]
      ],
      [
        [
          -16.721179755209874,
          28.049032510545516
        ],
        [
          -16.72020844125187,
          28.047318841771727
        ],
        [
          -16.71787915435698,
          28.045607259717855
        ],
        [
          -16.71670360602826,
          28.045948968233276
        ],
        [
          -16.717940955389764,
          28.049149719701163
        ],
        [
          -16.720150098321568,
          28.049552484771723
        ],
        [
          -16.721179755209874,
          28.049032510545516
        ]
      ],
      [
        [
          -13.835825341359623,
          28.859129271083177
        ],
        [
          -13.83609308817023,
          28.857878623143037
        ],
        [
          -13.834707944668537,
          28.857603478577317
        ],
        [
          -13.831731116510213,
          28.85943836214345
        ],
        [
          -13.8347542789449,
          28.860874178916788
        ],
        [
          -13.835897422884727,
          28.860202513115425
        ],
        [
          -13.83620997539441,
          28.85936102419919
        ],
        [
          -13.835825341359623,
          28.859129271083177
        ]
      ],
      [
        [
          -13.864442221006868,
          28.74228581535796
        ],
        [
          -13.86467939926132,
          28.742126529882015
        ],
        [
          -13.863788918539683,
          28.73995523324463
        ],
        [
          -13.860133674820759,
          28.739988839957974
        ],
        [
          -13.861243870903081,
          28.740847226377284
        ],
        [
          -13.864442221006868,
          28.74228581535796
        ]
      ],
      [
        [
          -15.404863595805637,
          28.120590630734753
        ],
        [
          -15.397528914623507,
          28.14708014255359
        ],
        [
          -15.396363824050582,
          28.165539063234647
        ],
        [
          -15.41063358236434,
          28.17156346359903
        ],
        [
          -15.414911374692423,
          28.15875563145643
        ],
        [
          -15.412177527100823,
          28.156520701577165
        ],
        [
          -15.4203635206851,
          28.148479136282972
        ],
        [
          -15.42720798408078,
          28.147631638419256
        ],
        [
          -15.427577760459315,
          28.14273849055234
        ],
        [
          -15.42652988199255,
          28.141767387072658
        ],
        [
          -15.427024245564903,
          28.14135356657181
        ],
        [
          -15.42824653277302,
          28.14095191045493
        ],
        [
          -15.428159881099672,
          28.140731233841905
        ],
        [
          -15.427496682533096,
          28.140750888967943
        ],
        [
          -15.42481784502823,
          28.14054753784808
        ],
        [
          -15.422239337847998,
          28.131885681587804
        ],
        [
          -15.404863595805637,
          28.120590630734753
        ]
      ],
      [
        [
          -15.71294134102962,
          28.102587143584728
        ],
        [
          -15.713492581805752,
          28.09967961205203
        ],
        [
          -15.711243451892727,
          28.097527489218564
        ],
        [
          -15.710908142860575,
          28.09859782371838
        ],
        [
          -15.712118957764687,
          28.10174028970198
        ],
        [
          -15.712609052649071,
          28.10247554655166
        ],
        [
          -15.71294134102962,
          28.102587143584728
        ]
      ],
      [
        [
          -13.860330340982102,
          28.4952034890012
        ],
        [
          -13.857895410840626,
          28.490696178124765
        ],
        [
          -13.852853749505272,
          28.490803012896265
        ],
        [
          -13.8546916927977,
          28.499180656142173
        ],
        [
          -13.855606826456494,
          28.499244730791688
        ],
        [
          -13.85792587522809,
          28.49861820801503
        ],
        [
          -13.859441902947253,
          28.49724850155866
        ],
        [
          -13.860330340982102,
          28.4952034890012
        ]
      ],
      [
        [
          -17.76578047492353,
          28.680206260926752
        ],
        [
          -17.76628577544372,
          28.680128878861428
        ],
        [
          -17.766616603350712,
          28.679711347553315
        ],
        [
          -17.767679639095547,
          28.679553320680455
        ],
        [
          -17.76842130778749,
          28.678207274956804
        ],
        [
          -17.770025224376326,
          28.67741934251569
        ],
        [
          -17.770243389105495,
          28.67567624673438
        ],
        [
          -17.76950969881422,
          28.673638060526734
        ],
        [
          -17.763869944723666,
          28.67086173706369
        ],
        [
          -17.76578047492353,
          28.680206260926752
        ]
      ],
      [
        [
          -13.612091527819103,
          28.956343152689627
        ],
        [
          -13.615055574914066,
          28.935325976859886
        ],
        [
          -13.610435148757603,
          28.935287829289962
        ],
        [
          -13.597731237159508,
          28.956727016803896
        ],
        [
          -13.612091527819103,
          28.956343152689627
        ]
      ],
      [
        [
          -15.379171385203108,
          27.948398375852776
        ],
        [
          -15.389640672373758,
          27.943611892341025
        ],
        [
          -15.397691612036255,
          27.925572780684845
        ],
        [
          -15.392610028204757,
          27.923111439814022
        ],
        [
          -15.39463041695737,
          27.918513180364286
        ],
        [
          -15.386404121927598,
          27.913813993180412
        ],
        [
          -15.365903599185685,
          27.945041344048718
        ],
        [
          -15.379171385203108,
          27.948398375852776
        ]
      ],
      [
        [
          -13.865072635443312,
          28.46627534674647
        ],
        [
          -13.87520430325739,
          28.461100835611447
        ],
        [
          -13.867388445250214,
          28.428011910349255
        ],
        [
          -13.859765571391364,
          28.431660684160192
        ],
        [
          -13.862081381171578,
          28.46644499838682
        ],
        [
          -13.865072635443312,
          28.46627534674647
        ]
      ],
      [
        [
          -17.757038185396482,
          28.637719961542686
        ],
        [
          -17.756475745643826,
          28.615591383620213
        ],
        [
          -17.751236492027772,
          28.617871115441645
        ],
        [
          -17.75005596221507,
          28.623629742318357
        ],
        [
          -17.754421705605296,
          28.637901432806927
        ],
        [
          -17.757038185396482,
          28.637719961542686
        ]
      ]
];

const SPECIAL_DOCK_POLYGONS: Coordinates[][] = [
    [
        [
            -13.453514363575465,
            29.22426583655401
        ],
        [
            -13.455267790753425,
            29.223938807030734
        ],
        [
            -13.454707381941049,
            29.22117584480015
        ],
        [
            -13.45259217824389,
            29.21853624020656
        ],
        [
            -13.447362603279728,
            29.21970182471962
        ],
        [
            -13.446974094207661,
            29.220651530004233
        ],
        [
            -13.451542702608037,
            29.223991135832506
        ],
        [
            -13.453514363575465,
            29.22426583655401
        ]
    ],
    [
        [
            -13.833793154534305,
            28.853511602043227
        ],
        [
            -13.798624643578734,
            28.854040789111693
        ],
        [
            -13.792603573883127,
            28.866502277807115
        ],
        [
            -13.811669144585636,
            28.878094350556182
        ],
        [
            -13.8461008334356,
            28.880113956501816
        ],
        [
            -13.882203130565273,
            28.866137530146048
        ],
        [
            -13.874736697913235,
            28.852143608871508
        ],
        [
            -13.83905914569388,
            28.85474119740543
        ],
        [
            -13.833793154534305,
            28.853511602043227
        ]
    ],
    [
        [
            -13.871998660241587,
            28.745161648162508
        ],
        [
            -13.897286957071202,
            28.72556630981778
        ],
        [
            -13.878161288757923,
            28.7065442152866
        ],
        [
            -13.862247538658607,
            28.703438723015225
        ],
        [
            -13.865939456646885,
            28.72314012967513
        ],
        [
            -13.843320879137252,
            28.72585727382321
        ],
        [
            -13.866174251793552,
            28.75057114072436
        ],
        [
            -13.871998660241587,
            28.745161648162508
        ]
    ],
    [
        [
            -14.358319457722672,
            28.06674334309656
        ],
        [
            -14.368227984519734,
            28.047430805816347
        ],
        [
            -14.327205686555828,
            28.03563379717373
        ],
        [
            -14.305097146872754,
            28.062514393920907
        ],
        [
            -14.332968018707305,
            28.074136354269854
        ],
        [
            -14.358319457722672,
            28.06674334309656
        ]
    ],
    [
        [
            -15.713735615511013,
            28.09415343618251
        ],
        [
            -15.689163452129634,
            28.09481527981059
        ],
        [
            -15.697403382265264,
            28.107885059981513
        ],
        [
            -15.709550509320138,
            28.109864156815803
        ],
        [
            -15.71454088954269,
            28.103790260953673
        ],
        [
            -15.713735615511013,
            28.09415343618251
        ]
    ]
];

const SPECIAL_AMPLIFIED_DOCK_POLYGONS: Coordinates[][] = [
    [
        [
            -13.871998660241587,
            28.745161648162508
        ],
        [
            -13.897286957071202,
            28.72556630981778
        ],
        [
            -13.878161288757923,
            28.7065442152866
        ],
        [
            -13.862247538658607,
            28.703438723015225
        ],
        [
            -13.865939456646885,
            28.72314012967513
        ],
        [
            -13.843320879137252,
            28.72585727382321
        ],
        [
            -13.866174251793552,
            28.75057114072436
        ],
        [
            -13.871998660241587,
            28.745161648162508
        ]
    ],
    [
        [
            -13.833793154534305,
            28.853511602043227
        ],
        [
            -13.798624643578734,
            28.854040789111693
        ],
        [
            -13.792603573883127,
            28.866502277807115
        ],
        [
            -13.811669144585636,
            28.878094350556182
        ],
        [
            -13.8461008334356,
            28.880113956501816
        ],
        [
            -13.882203130565273,
            28.866137530146048
        ],
        [
            -13.874736697913235,
            28.852143608871508
        ],
        [
            -13.83905914569388,
            28.85474119740543
        ],
        [
            -13.833793154534305,
            28.853511602043227
        ]
    ],
    [
        [
            -16.249578864845603,
            28.45881603126891
        ],
        [
            -16.24615642200311,
            28.454765341808482
        ],
        [
            -16.239414646480753,
            28.471901113845178
        ],
        [
            -16.242116982789412,
            28.473156723304896
        ],
        [
            -16.24708485555928,
            28.470744637365442
        ],
        [
            -16.245994956652822,
            28.46721194446367
        ],
        [
            -16.249578864845603,
            28.45881603126891
        ]
    ],
    [
        [
            -16.721179755209874,
            28.049032510545516
        ],
        [
            -16.72020844125187,
            28.047318841771727
        ],
        [
            -16.71787915435698,
            28.045607259717855
        ],
        [
            -16.71670360602826,
            28.045948968233276
        ],
        [
            -16.717940955389764,
            28.049149719701163
        ],
        [
            -16.720150098321568,
            28.049552484771723
        ],
        [
            -16.721179755209874,
            28.049032510545516
        ]
    ]
];

const SPECIAL_PRICE_TFN_POLYGONS: Coordinates[][] = [
    [
        [
          -16.35902012894647,
          28.489251343908364
        ],
        [
          -16.35804752995901,
          28.484397040367824
        ],
        [
          -16.32466038851635,
          28.474732707486083
        ],
        [
          -16.322689735410023,
          28.479292569496977
        ],
        [
          -16.328309316608426,
          28.48008459900113
        ],
        [
          -16.33818337895815,
          28.487657963537544
        ],
        [
          -16.344513056509783,
          28.48788614015332
        ],
        [
          -16.345612050301412,
          28.48911573243207
        ],
        [
          -16.35902012894647,
          28.489251343908364
        ]
      ]
];

const ISLANDS_ROUND_ZONE_POLYGONS: Partial<{ [key in Island]: Partial<{ [key in CardinalPoint]: Coordinates[] }> }> = {
    "TNF": {
        'NORTH': [
            
                [
                    -16.875854968092682,
                    28.387388199006764
                ],
                [
                    -16.84789309799072,
                    28.35447720767445
                ],
                [
                    -16.750243087223737,
                    28.327193251903054
                ],
                [
                    -16.48091815100088,
                    28.360597437227057
                ],
                [
                    -16.529844849171837,
                    28.428653441020387
                ],
                [
                    -16.79856970141431,
                    28.402635735622106
                ],
                [
                    -16.875854968092682,
                    28.387388199006764
                ]
            
        ],
        'WEST': [
            [
                -16.869229831504015,
                28.29073849146434
            ],
            [
                -16.837823079915466,
                28.19423532729177
            ],
            [
                -16.78618529223398,
                28.123558091040163
            ],
            [
                -16.690015763620522,
                27.97473723147725
            ],
            [
                -16.60477304881934,
                28.019991697124503
            ],
            [
                -16.570183815081922,
                28.030138261844908
            ],
            [
                -16.591819782513802,
                28.04057658450752
            ],
            [
                -16.581354468561923,
                28.074254085966658
            ],
            [
                -16.604959498121346,
                28.113770908059468
            ],
            [
                -16.652431230096994,
                28.088355871705232
            ],
            [
                -16.788297231415157,
                28.257267489705754
            ],
            [
                -16.795634171702858,
                28.30386575662267
            ],
            [
                -16.869229831504015,
                28.29073849146434
            ]
        ],
    },
    "GC": {
        'NORTH': [
            [
                -15.721606775427375,
                28.170571845742742
            ],
            [
                -15.71435274966666,
                28.08920021723972
            ],
            [
                -15.668726865691525,
                28.075468899543694
            ],
            [
                -15.64463883266427,
                28.12407172066196
            ],
            [
                -15.678456858105989,
                28.174698044715726
            ],
            [
                -15.721606775427375,
                28.170571845742742
            ]
        ],
        'WEST': [
            [
                -15.839120666863579,
                27.921188657258497
            ],
            [
                -15.776619947961308,
                27.818262722476838
            ],
            [
                -15.752100594968311,
                27.808922378008376
            ],
            [
                -15.681194258828043,
                27.896096339932782
            ],
            [
                -15.732478546469451,
                27.94451841955795
            ],
            [
                -15.788774298330381,
                27.939423676147825
            ],
            [
                -15.839120666863579,
                27.921188657258497
            ]
        ],

    }
}

const ISLAND_ZONE_POLYGONS: { [key in Island]: Coordinates[]} = {
    GC: [
        [
            -15.54764784528382,
            28.243044402318034
        ],
        [
            -15.788819240097865,
            28.215948810847365
        ],
        [
            -15.95229783658337,
            27.92173498969356
        ],
        [
            -15.669042842673406,
            27.62958641144938
        ],
        [
            -15.306476450468807,
            27.767165824081474
        ],
        [
            -15.287053250886458,
            28.19883226216855
        ],
        [
            -15.54764784528382,
            28.243044402318034
        ]
    ],
    TNF: [
        [
            -16.727127234800776,
            28.536662159810973
        ],
        [
            -17.036279828153596,
            28.412879181511457
        ],
        [
            -16.84852223219039,
            28.032090903509697
        ],
        [
            -16.64619723654107,
            27.850491586281976
        ],
        [
            -16.30305404391882,
            28.159171171936137
        ],
        [
            -15.912971452305356,
            28.512486086679488
        ],
        [
            -16.150905647190115,
            28.71283732944444
        ],
        [
            -16.727127234800776,
            28.536662159810973
        ]
    ],
    FTV: [
        [
            -13.910123633296507,
            28.820087216389723
        ],
        [
            -14.081695229607647,
            28.76476599207554
        ],
        [
            -14.261359825744336,
            28.355334163559434
        ],
        [
            -14.656298217253209,
            28.070073004752345
        ],
        [
            -14.384373423100016,
            27.977199373193343
        ],
        [
            -13.832430834967056,
            28.16001243954915
        ],
        [
            -13.689994038029027,
            28.800231693105502
        ],
        [
            -13.910123633296507,
            28.820087216389723
        ]
    ],
    LNZ: [
        [
            -13.899551200404971,
            28.836633252525687
        ],
        [
            -13.685896004998853,
            28.81678088395182
        ],
        [
            -13.318473812898901,
            29.063248132902956
        ],
        [
            -13.357320212063655,
            29.482582566618106
        ],
        [
            -13.72312380419848,
            29.479764527586084
        ],
        [
            -13.952964999256693,
            28.917421643187936
        ],
        [
            -13.899551200404971,
            28.836633252525687
        ]
    ],
    LP: [
        [
            -17.865361159927545,
            28.961923852129758
        ],
        [
            -18.14931590097612,
            28.80629271383816
        ],
        [
            -17.906545435347084,
            28.34182127734431
        ],
        [
            -17.66160737627507,
            28.389504724768727
        ],
        [
            -17.62692588118574,
            28.87085099684063
        ],
        [
            -17.865361159927545,
            28.961923852129758
        ]
    ]
}

export async function calculateEstimatePrice(
    parameters: Parameters,
    db: Database
): Promise<{price: number, metadata: {[key: string]: any}}> {
    const {
        serviceType,
        departureDateTime,
        arrivalDateTime = undefined,
        originCoordinates,
        destinationCoordinates,
        pax,
        rate = 1.3,
        vehicleType = undefined,
        kidStroller = 0,
        surfBoard = 0,
        golfBag = 0,
        bike = 0,
        specialLuggage = 0,
        extraLuggage = 0,
    } = parameters;

    const SPECIAL_PRICE_FTV_IS_ACTIVE: boolean = true; // Cuidado!! Esta variable se comporta como constante!!!

    let priceWith20: number = 0;
    const metadata: { [key: string]: any } = {};

    // Conditions check
    if (serviceType == ServiceType.A_DISPOSICION && !arrivalDateTime) {
        console.error("There is no arrivalDateTime and the service is 'A Disposicion'")
        return{price: -1, metadata: {}};
    }

    
    const island = calculateIslandFromCoordinates(originCoordinates, ISLAND_ZONE_POLYGONS);
    if (!island) {
        console.error("The coordinates are not in any available island")
        return{price: -1, metadata: {}};
    }

    const zoneLevel: ZoneLevel = calculateZoneLevel(originCoordinates, destinationCoordinates, HARD_ZONE_POLYGONS, VERY_HARD_ZONE_POLYGONS);
    const dayTime: DayTime = calculateDayTime(departureDateTime);
    const isLuxury: boolean = calculateIsLuxury(vehicleType);
    const nearestAirport: Airport = await calculateNearestAirport(originCoordinates, island, ISLANDS_ROUND_ZONE_POLYGONS, db);
    const isAdapted: boolean = calculateIsAdapted(vehicleType);

    metadata['island'] = island;
    metadata['zoneLevel'] = zoneLevel;
    metadata['dayTime'] = dayTime;
    metadata['isLuxury'] = isLuxury;
    metadata['nearestAirport'] = nearestAirport;

    console.log(`üëÅÔ∏è Island is ${island} / Zone level is ${zoneLevel} / Day time is ${dayTime} / ${isLuxury ? 'Is luxury' : 'Is not luxury'} / Nearest airport is ${nearestAirport}`)

    if (serviceType == ServiceType.PRIVADO) {

        metadata['serviceType'] = 'Privado';

        const isShuttleZone: boolean = isPointInAnyPolygon(originCoordinates, SHUTTLE_ZONE_POLYGONS) || isPointInAnyPolygon(destinationCoordinates, SHUTTLE_ZONE_POLYGONS);

        metadata['isShuttleZone'] = isShuttleZone;

        let kilometersHours: number = 0;
        const reducedKMH = await calculateReducedKMH(originCoordinates, destinationCoordinates, isShuttleZone, db)
        const isReduced: boolean = reducedKMH.isReduced;

        metadata['isReduced'] = isReduced;

        let isSpecial = false;

        if (isReduced) {
            const routeKilometers = reducedKMH.kilometers;
            const routeHours = reducedKMH.hours;
            kilometersHours = routeKilometers * routeHours;
            console.log(`Is reduced and üöå Kilometers are ${routeKilometers} / Hours are ${routeHours} / KilometersHours are ${kilometersHours}`)

            metadata['routeKilometers'] = routeKilometers;
            metadata['routeHours'] = routeHours;
            metadata['kilometersHours'] = kilometersHours;
            metadata['isSpecial'] = isSpecial;
        } else {
            const {coordinates: customRoute, roundTrip: isRoundTrip} = calculateCustomRoute(originCoordinates, destinationCoordinates, island, serviceType, nearestAirport, pax, AIRPORT_COORDINATES, ISLANDS_ROUND_ZONE_POLYGONS);

            if (isRoundTrip || (
                    isPointInAnyPolygon(originCoordinates, SPECIAL_DOCK_POLYGONS)
                    || isPointInAnyPolygon(destinationCoordinates, SPECIAL_DOCK_POLYGONS)
                )
            ) {
                isSpecial = true;
            }

            metadata['customRoute'] = customRoute;
            metadata['roundTrip'] = isRoundTrip;
            
            const { kilometers: routeKilometers, hours: routeHours } = await calculateKilometersBetweenPoints(customRoute, db);
            kilometersHours = routeKilometers * routeHours;
            console.log(`Is not reduced and üöå Kilometers are ${routeKilometers} / Hours are ${routeHours} / KilometersHours are ${kilometersHours}`)

            metadata['routeKilometers'] = routeKilometers;
            metadata['routeHours'] = routeHours;
            metadata['kilometersHours'] = kilometersHours;
            metadata['isSpecial'] = isSpecial;
        }

        priceWith20 = calculateModelPrice(
            zoneLevel,
            pax,
            island,
            isLuxury,
            kilometersHours,
            nearestAirport,
            isReduced,
            isAdapted,
            isSpecial,
            MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA,
        )

        // TODO: Send to a function
        let offerPrice = 0;

        if (isPointInAnyPolygon(originCoordinates, SPECIAL_AMPLIFIED_DOCK_POLYGONS)
        || isPointInAnyPolygon(destinationCoordinates, SPECIAL_AMPLIFIED_DOCK_POLYGONS)) {
            if (island == Island.TNF) {
                if (pax <= 9 || isLuxury || isAdapted) {
                    if (isReduced) {
                        offerPrice = -6;
                    } else {
                        offerPrice = calculatePricesWithTresholds(kilometersHours, [
                            [30, 0],
                            [50, 12],
                            [200, 0],
                            [400, 36],
                            [500, 12],
                            [650, 24],
                            [Infinity, 0]
                        ])
                    }
                } else {
                    if (isReduced) {
                        offerPrice = -12;
                    } else {
                        offerPrice = calculatePricesWithTresholds(kilometersHours, [
                            [30, 0],
                            [50, 12],
                            [200, 0],
                            [400, 24],
                            [500, 12],
                            [580, 24],
                            [Infinity, 0]
                        ])
                    }
                }
            } 
        }

        if (island == Island.TNF && (
            isPointInAnyPolygon(originCoordinates, SPECIAL_PRICE_TFN_POLYGONS)
            || isPointInAnyPolygon(destinationCoordinates, SPECIAL_PRICE_TFN_POLYGONS)
            )
        ) {
            if (!isReduced) {
                if (pax <= 9 || isLuxury || isAdapted) {
                    offerPrice = offerPrice + calculatePricesWithTresholds(kilometersHours, [
                        [60, 6],
                        [370, 0],
                        [400, -12],
                        [Infinity, 0]
                    ])
                } else {
                    offerPrice = offerPrice + calculatePricesWithTresholds(kilometersHours, [
                        [30, 12],
                        [60, 6],
                        [370, 0],
                        [400, -12],
                        [Infinity, 0]
                    ])
                }
            }
        }

        priceWith20 = priceWith20 - offerPrice;

    } else if (serviceType == ServiceType.A_DISPOSICION && arrivalDateTime) {
        metadata['serviceType'] = 'A Disposicion';
        priceWith20 = calculateAtDisposalPrice(
            pax,
            departureDateTime,
            arrivalDateTime,
            isLuxury,
            isAdapted,
            island,
            zoneLevel,
            MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA
        )
    } else if (serviceType == ServiceType.SHUTTLE) {
        const AIRPORT_TRESHOLD = 1000;

        const IS_ORIGIN_AIRPORT = isAirportCloseToCoordinates(originCoordinates, AIRPORT_COORDINATES, AIRPORT_TRESHOLD);
        const IS_DESTINATION_AIRPORT = isAirportCloseToCoordinates(destinationCoordinates, AIRPORT_COORDINATES, AIRPORT_TRESHOLD);

        console.log('üåà', originCoordinates, IS_ORIGIN_AIRPORT)
        console.log('üåà', destinationCoordinates, IS_DESTINATION_AIRPORT)
        console.log('ü•ë', AIRPORT_COORDINATES, AIRPORT_TRESHOLD)
        
        if (IS_ORIGIN_AIRPORT || IS_DESTINATION_AIRPORT) {
            metadata['serviceType'] = 'Shuttle';

            const shuttleAirport = IS_ORIGIN_AIRPORT ? IS_ORIGIN_AIRPORT : IS_DESTINATION_AIRPORT;
            console.log(`üõ´ Is SHUTTLE and ${IS_ORIGIN_AIRPORT ? 'origin' : 'destination'} is airport ${shuttleAirport}`)

            const ISLAND_PLACES = await getIslandsPlacesForShuttle();
            const isShuttlePoint = isPlaceSuitableForShuttle(IS_ORIGIN_AIRPORT ? destinationCoordinates : originCoordinates, ISLAND_PLACES[island]);

            console.log('üêå', isShuttlePoint, shuttleAirport)
            if (isShuttlePoint && shuttleAirport) {

                metadata['isShuttlePoint'] = isShuttlePoint;

                console.log(`üè® Is Shuttle point`)

                const AIRPORT_PRICES = await getAirportsPricesForShuttle();
                console.log('üåà', AIRPORT_PRICES)
                const shuttlePaxPrice = AIRPORT_PRICES[shuttleAirport][isShuttlePoint] || 0;

                if (shuttlePaxPrice.price) {
                    priceWith20 = shuttlePaxPrice.price * pax;
                }
            }
        } else {
            console.log('Is not shuttle...')
        }
    }

    // TODO: Set rate to extraLuggage too
    // This is to normalize the price with the rate selected
    let priceWithRate = serviceType != ServiceType.SHUTTLE ? (priceWith20 / 1.2) * rate : priceWith20;


    let luggagePrice: number = 0; // Tarifa del 20 se puede meter
    let luggageManipulationPrice: number = 0; // PRECIO FIJO SIN TARIFA

    const luggagePackages = (kidStroller + surfBoard + golfBag + bike + specialLuggage + extraLuggage);

    // TODO: Check when apply rate to extra luggage on shuttle or not.
    if (serviceType == ServiceType.SHUTTLE) {
        luggagePrice = calculatePriceLuggage(luggagePackages);
    } else if (SPECIAL_PRICE_FTV_IS_ACTIVE && pax >= 9 && pax <= 30 && !isLuxury && !isAdapted) {
        if (luggagePackages > 0) {
            luggageManipulationPrice = calculatePriceLuggageManipulation(pax, isLuxury, luggagePackages, originCoordinates, destinationCoordinates, LUGGAGE_ZONE_POLYGONS)
        }
    } else {
        luggagePrice = calculatePriceLuggage(luggagePackages);
        luggageManipulationPrice = calculatePriceLuggageManipulation(pax, isLuxury, luggagePackages, originCoordinates, destinationCoordinates, LUGGAGE_ZONE_POLYGONS)
    }

    luggagePrice = (luggagePrice / 1.2) * rate;

    console.log(`üí∞ Price with rate is ${priceWithRate}, luggage price is ${luggagePrice} and luggage manipulation is ${luggageManipulationPrice}`)

    // Nocturnidad:
    // TODO: Check the business requirements
    if (serviceType == ServiceType.PRIVADO && dayTime == DayTime.NIGHT) {
        priceWithRate = priceWithRate * 1.3;
        luggagePrice = luggagePrice * 1.3;
    }

    metadata['priceWithRate'] = priceWithRate;
    metadata['luggagePrice'] = luggagePrice;
    metadata['luggageManipulationPrice'] = luggageManipulationPrice;

    // TODO: Add Taxes
    let taxesRate = calculateTaxes(pax, isLuxury, serviceType);
    metadata['taxes'] = taxesRate;
    
    let priceWithTaxes = (luggageManipulationPrice + priceWithRate + luggagePrice) * (1 + taxesRate);
    metadata['priceWithTaxes'] = priceWithTaxes;


    return {price: priceWithTaxes, metadata: metadata};
}