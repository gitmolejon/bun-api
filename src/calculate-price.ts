import Database from 'bun:sqlite';
import {
    Parameters,
    Airport,
    Coordinates,
    Island,
    ZoneLevel,
    CardinalPoint,
    Constants,
    DayTime,
    ServiceType,
    VehicleType
} from './types';

import {
    calculateZoneLevel,
    calculateNearestAirport,
    calculateKilometersBetweenPoints,
    calculateCustomRoute,
    calculateDayTime,
    calculateIsLuxury,
    calculateReducedKMH,
    calculateAtDisposalPrice,
    calculateModelPrice,
    calculatePriceLuggage,
    isPointInPolygon,
    calculateIslandFromCoordinates,
    isPointInAnyPolygon,
    isAirportCloseToCoordinates,
    isPlaceSuitableForShuttle,
    getIslandsPlacesForShuttle,
    getAirportsPricesForShuttle,
} from './utils';


const MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA: number = 15;

const AIRPORT_COORDINATES: { [key in Airport]: Coordinates } = {
    [Airport.VDE]: [27.814847, -17.887056],
    [Airport.SPC]: [28.626478, -17.755611],
    [Airport.GMZ]: [28.029722, -17.214167],
    [Airport.TFN]: [28.4845157,-16.3459953],
    [Airport.TFS]: [28.044475, -16.572488],
    [Airport.LPA]: [27.931886, -15.386586],
    [Airport.ACE]: [28.945464, -13.605225],
    [Airport.FUE]: [28.452717, -13.863761],
};

const HARD_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -15.701985392951343,
            28.085704796240307
        ],
        [
            -15.764014759554485,
            28.05949752698529
        ],
        [
            -15.818439910390452,
            28.01873765376763
        ],
        [
            -15.840958230769786,
            27.9616085943332
        ],
        [
            -15.830058922807154,
            27.895751363789145
        ],
        [
            -15.729514381087597,
            27.90282065544462
        ],
        [
            -15.67624287628621,
            27.85526397828393
        ],
        [
            -15.665954525477936,
            27.822684114789766
        ],
        [
            -15.630993153754584,
            27.844097007750428
        ],
        [
            -15.607442821681971,
            27.85450246852974
        ],
        [
            -15.546154064195008,
            27.852293833967344
        ],
        [
            -15.494947737105292,
            27.902284882373976
        ],
        [
            -15.518140686887364,
            27.989098616323254
        ],
        [
            -15.520486824533862,
            28.017369897710946
        ],
        [
            -15.56217611189831,
            28.055115856835954
        ],
        [
            -15.605408615041796,
            28.06906263856004
        ],
        [
            -15.668408889151891,
            28.07529754081488
        ],
        [
            -15.701985392951343,
            28.085704796240307
        ]
    ],
    [
        [
            -16.656311919390305,
            28.157211155930653
        ],
        [
            -16.63758684048568,
            28.138305307030393
        ],
        [
            -16.61488389476756,
            28.15387507174978
        ],
        [
            -16.64016476388764,
            28.17876884862808
        ],
        [
            -16.648961510650793,
            28.178656290730387
        ],
        [
            -16.660758466523077,
            28.17865575076202
        ],
        [
            -16.656311919390305,
            28.157211155930653
        ]
    ],
    [
        [
            -16.783544733028805,
            28.382143927591457
        ],
        [
            -16.83350369272938,
            28.40003662422528
        ],
        [
            -16.9365810860306,
            28.356081202484134
        ],
        [
            -16.861277203338688,
            28.280224390367422
        ],
        [
            -16.785622431045965,
            28.29762862714665
        ],
        [
            -16.777655987904637,
            28.32457604350094
        ],
        [
            -16.79044315490131,
            28.36376190928945
        ],
        [
            -16.783544733028805,
            28.382143927591457
        ]
    ],
    [
        [
            -16.306299837690432,
            28.58006795680808
        ],
        [
            -16.312050642481893,
            28.536734785574538
        ],
        [
            -16.260421712701998,
            28.542524002179988
        ],
        [
            -16.242416237037077,
            28.53830601391732
        ],
        [
            -16.24601398254606,
            28.532017498201952
        ],
        [
            -16.20762604136212,
            28.526648334120566
        ],
        [
            -16.175875602596648,
            28.532924063805737
        ],
        [
            -16.154204908198523,
            28.51655641129527
        ],
        [
            -16.11923052369906,
            28.532680328199973
        ],
        [
            -16.117235786940682,
            28.58664244075588
        ],
        [
            -16.162848767485343,
            28.597151320370386
        ],
        [
            -16.306299837690432,
            28.58006795680808
        ]
    ],
    [
        [
            -14.183786244273449,
            28.34584242653837
        ],
        [
            -14.176539044338597,
            28.33862940024244
        ],
        [
            -14.147015576867375,
            28.369454632841624
        ],
        [
            -14.10259122454994,
            28.429313615713497
        ],
        [
            -14.071300225749908,
            28.479187549404443
        ],
        [
            -14.02573464687245,
            28.55966875422034
        ],
        [
            -14.009568164773043,
            28.653831745470214
        ],
        [
            -14.022609103836032,
            28.656692669502277
        ],
        [
            -14.166683226073133,
            28.412108356587837
        ],
        [
            -14.183786244273449,
            28.34584242653837
        ]
    ]
];

const VERY_HARD_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -16.784900008744557,
            28.27234712173977
        ],
        [
            -16.729286538097583,
            28.201622806853692
        ],
        [
            -16.677546955705026,
            28.179954504036047
        ],
        [
            -16.646708682673307,
            28.179020208925618
        ],
        [
            -16.597431947502002,
            28.22582283618994
        ],
        [
            -16.530024367100793,
            28.2864923828934
        ],
        [
            -16.47399916374019,
            28.306803239293494
        ],
        [
            -16.446164085275143,
            28.362616378354232
        ],
        [
            -16.523027587190853,
            28.35363446637001
        ],
        [
            -16.756111364570415,
            28.305024532056194
        ],
        [
            -16.784900008744557,
            28.27234712173977
        ]
    ]
];

const SHUTTLE_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -13.469788538386439,
            29.001945199600584
        ],
        [
            -13.491990446012466,
            29.01931760392749
        ],
        [
            -13.548089142709763,
            29.021644356085094
        ],
        [
            -13.5795508950835,
            28.98777498546584
        ],
        [
            -13.62023231903671,
            28.979490955901365
        ],
        [
            -13.661799114586472,
            28.965657405113248
        ],
        [
            -13.890799924681346,
            28.864311102600723
        ],
        [
            -13.792034518819008,
            28.83107779100021
        ],
        [
            -13.586268156294892,
            28.922230024152256
        ],
        [
            -13.469788538386439,
            29.001945199600584
        ]
    ],
    [
        [
            -15.43398273775972,
            28.15679051085658
        ],
        [
            -15.519644446359308,
            28.14889915691535
        ],
        [
            -15.532944482467798,
            28.115221712022475
        ],
        [
            -15.459851512950635,
            28.061239262532574
        ],
        [
            -15.425220073381787,
            28.01841518792585
        ],
        [
            -15.384467326963716,
            28.023495590746137
        ],
        [
            -15.39305237423585,
            28.155888340882854
        ],
        [
            -15.403626051479279,
            28.169319863194815
        ],
        [
            -15.43398273775972,
            28.15679051085658
        ]
    ],
    [
        [
            -13.873221407567627,
            28.75308271997963
        ],
        [
            -13.897286957071202,
            28.72556630981778
        ],
        [
            -13.878161288757923,
            28.7065442152866
        ],
        [
            -13.862247538658607,
            28.703438723015225
        ],
        [
            -13.865939456646885,
            28.72314012967513
        ],
        [
            -13.843320879137252,
            28.72585727382321
        ],
        [
            -13.866174251793552,
            28.75057114072436
        ],
        [
            -13.873221407567627,
            28.75308271997963
        ]
    ],
    [
        [
            -13.890189526231524,
            28.53477274079522
        ],
        [
            -13.896321358994214,
            28.498271555744296
        ],
        [
            -13.894587705049986,
            28.35776813754555
        ],
        [
            -13.866884210717245,
            28.34653695911865
        ],
        [
            -13.838466150894646,
            28.41467930494079
        ],
        [
            -13.829954271280116,
            28.54811081082363
        ],
        [
            -13.890189526231524,
            28.53477274079522
        ]
    ],
    [
        [
            -14.226383478285811,
            28.179334256160615
        ],
        [
            -14.36005016990751,
            28.069055235299558
        ],
        [
            -14.371891639436,
            28.047710147916234
        ],
        [
            -14.328647952948074,
            28.03777417494622
        ],
        [
            -14.262710265700207,
            28.100055978790152
        ],
        [
            -14.142862005527661,
            28.18716105253874
        ],
        [
            -14.156068847839421,
            28.196784281821323
        ],
        [
            -14.207672851957028,
            28.178841934802605
        ],
        [
            -14.226383478285811,
            28.179334256160615
        ]
    ],
    [
        [
            -16.860497609954393,
            28.252379352581983
        ],
        [
            -16.709149483497868,
            27.977574561465858
        ],
        [
            -16.528140210484736,
            28.02274149280838
        ],
        [
            -16.457243463877347,
            28.11070466647095
        ],
        [
            -16.484788359302968,
            28.125165397173703
        ],
        [
            -16.652681016776427,
            28.055736121871576
        ],
        [
            -16.67629092173317,
            28.056314884658903
        ],
        [
            -16.726134054420697,
            28.13615424649751
        ],
        [
            -16.839592764353938,
            28.254646413247514
        ],
        [
            -16.860497609954393,
            28.252379352581983
        ]
    ],
    [
        [
            -16.380760558230747,
            28.377551664598116
        ],
        [
            -16.35565130628723,
            28.36840006201173
        ],
        [
            -16.249474046784243,
            28.445951938999194
        ],
        [
            -16.242197361409893,
            28.470407158042846
        ],
        [
            -16.16577922028104,
            28.515612570277533
        ],
        [
            -16.297850757744726,
            28.524033354536016
        ],
        [
            -16.351128367139637,
            28.494247549305598
        ],
        [
            -16.344698718121478,
            28.45181691064225
        ],
        [
            -16.380760558230747,
            28.377551664598116
        ]
    ],
    [
        [
            -16.594261766046543,
            28.40644037173611
        ],
        [
            -16.55199837348107,
            28.371417733599955
        ],
        [
            -16.501773586345593,
            28.387086129931603
        ],
        [
            -16.439024022491992,
            28.435897881066523
        ],
        [
            -16.481245451208565,
            28.444109599192032
        ],
        [
            -16.594261766046543,
            28.40644037173611
        ]
    ],
    [
        [
            -15.748812018771304,
            27.84873350360448
        ],
        [
            -15.770788499479437,
            27.81788012196951
        ],
        [
            -15.670299421253844,
            27.742152880072453
        ],
        [
            -15.571134075557723,
            27.735672058646998
        ],
        [
            -15.423155439200343,
            27.804863290724086
        ],
        [
            -15.46176645553578,
            27.82509050188427
        ],
        [
            -15.499589248816761,
            27.79775756614292
        ],
        [
            -15.611217504481175,
            27.79996022340066
        ],
        [
            -15.693245333624333,
            27.815560782932593
        ],
        [
            -15.748812018771304,
            27.84873350360448
        ]
    ]
];

const LUGGAGE_ZONE_POLYGONS: Coordinates[][] = [
    [
        [
            -15.713735615511013,
            28.09415343618251
        ],
        [
            -15.689163452129634,
            28.09481527981059
        ],
        [
            -15.697403382265264,
            28.107885059981513
        ],
        [
            -15.709550509320138,
            28.109864156815803
        ],
        [
            -15.71454088954269,
            28.103790260953673
        ],
        [
            -15.713735615511013,
            28.09415343618251
        ]
    ],
    [
        [
            -15.379171385203108,
            27.948398375852776
        ],
        [
            -15.389640672373758,
            27.943611892341025
        ],
        [
            -15.397691612036255,
            27.925572780684845
        ],
        [
            -15.392610028204757,
            27.923111439814022
        ],
        [
            -15.39463041695737,
            27.918513180364286
        ],
        [
            -15.386404121927598,
            27.913813993180412
        ],
        [
            -15.365903599185685,
            27.945041344048718
        ],
        [
            -15.379171385203108,
            27.948398375852776
        ]
    ],
    [
        [
            -15.404863595805637,
            28.120590630734753
        ],
        [
            -15.397528914623507,
            28.14708014255359
        ],
        [
            -15.396363824050582,
            28.165539063234647
        ],
        [
            -15.41063358236434,
            28.17156346359903
        ],
        [
            -15.414911374692423,
            28.15875563145643
        ],
        [
            -15.412177527100823,
            28.156520701577165
        ],
        [
            -15.4203635206851,
            28.148479136282972
        ],
        [
            -15.42720798408078,
            28.147631638419256
        ],
        [
            -15.425522542008707,
            28.141109039849184
        ],
        [
            -15.422239337847998,
            28.131885681587804
        ],
        [
            -15.404863595805637,
            28.120590630734753
        ]
    ],
    [
        [
            -16.588751629975917,
            28.046724483770703
        ],
        [
            -16.594336838393247,
            28.038963168175215
        ],
        [
            -16.590296474857126,
            28.033823610495247
        ],
        [
            -16.552150689708384,
            28.047563511370242
        ],
        [
            -16.562132764327032,
            28.056163166835518
        ],
        [
            -16.57770865000107,
            28.054213311163664
        ],
        [
            -16.588751629975917,
            28.046724483770703
        ]
    ],
    [
        [
            -16.249578864845603,
            28.45881603126891
        ],
        [
            -16.24615642200311,
            28.454765341808482
        ],
        [
            -16.239414646480753,
            28.471901113845178
        ],
        [
            -16.242116982789412,
            28.473156723304896
        ],
        [
            -16.24708485555928,
            28.470744637365442
        ],
        [
            -16.245994956652822,
            28.46721194446367
        ],
        [
            -16.249578864845603,
            28.45881603126891
        ]
    ],
    [
        [
            -16.721179755209874,
            28.049032510545516
        ],
        [
            -16.720950766263726,
            28.04848493727971
        ],
        [
            -16.71787915435698,
            28.045607259717855
        ],
        [
            -16.71670360602826,
            28.045948968233276
        ],
        [
            -16.717940955389764,
            28.049149719701163
        ],
        [
            -16.720150098321568,
            28.049552484771723
        ],
        [
            -16.721179755209874,
            28.049032510545516
        ]
    ],
    [
        [
            -13.835529743799981,
            28.85945825150783
        ],
        [
            -13.836100780190094,
            28.85801600818192
        ],
        [
            -13.835477589401421,
            28.856999387526017
        ],
        [
            -13.831901339606617,
            28.859475850593086
        ],
        [
            -13.83388917762852,
            28.85970597282052
        ],
        [
            -13.835529743799981,
            28.85945825150783
        ]
    ],
    [
        [
            -13.865072635443312,
            28.46627534674647
        ],
        [
            -13.87520430325739,
            28.461100835611447
        ],
        [
            -13.867388445250214,
            28.428011910349255
        ],
        [
            -13.859765571391364,
            28.431660684160192
        ],
        [
            -13.862081381171578,
            28.46644499838682
        ],
        [
            -13.865072635443312,
            28.46627534674647
        ]
    ],
    [
        [
            -13.864442221006868,
            28.74228581535796
        ],
        [
            -13.86467939926132,
            28.742126529882015
        ],
        [
            -13.863788918539683,
            28.73995523324463
        ],
        [
            -13.860133674820759,
            28.739988839957974
        ],
        [
            -13.861243870903081,
            28.740847226377284
        ],
        [
            -13.864442221006868,
            28.74228581535796
        ]
    ],
    [
        [
            -14.363073210166846,
            28.053070596258095
        ],
        [
            -14.365230021892756,
            28.051624150922663
        ],
        [
            -14.364647545107488,
            28.048331402631376
        ],
        [
            -14.359940502978333,
            28.046358484044532
        ],
        [
            -14.356666039263132,
            28.049039977505856
        ],
        [
            -14.357733775816001,
            28.05027329516888
        ],
        [
            -14.363073210166846,
            28.053070596258095
        ]
    ],
    [
        [
            -13.612091527819103,
            28.956343152689627
        ],
        [
            -13.615055574914066,
            28.935325976859886
        ],
        [
            -13.610435148757603,
            28.935287829289962
        ],
        [
            -13.597731237159508,
            28.956727016803896
        ],
        [
            -13.612091527819103,
            28.956343152689627
        ]
    ],
    [
        [
            -13.860330340982102,
            28.4952034890012
        ],
        [
            -13.857895410840626,
            28.490696178124765
        ],
        [
            -13.852853749505272,
            28.490803012896265
        ],
        [
            -13.8546916927977,
            28.499180656142173
        ],
        [
            -13.855606826456494,
            28.499244730791688
        ],
        [
            -13.85792587522809,
            28.49861820801503
        ],
        [
            -13.859441902947253,
            28.49724850155866
        ],
        [
            -13.860330340982102,
            28.4952034890012
        ]
    ],
    [
        [
            -13.525006216589475,
            28.974005942181066
        ],
        [
            -13.529784214569219,
            28.973739091428868
        ],
        [
            -13.537156982473988,
            28.9662988855697
        ],
        [
            -13.530189793419964,
            28.96001797487537
        ],
        [
            -13.523133967581316,
            28.96969713302947
        ],
        [
            -13.525006216589475,
            28.974005942181066
        ]
    ],
    [
        [
            -16.35902012894647,
            28.489251343908364
        ],
        [
            -16.35804752995901,
            28.484397040367824
        ],
        [
            -16.32466038851635,
            28.474732707486083
        ],
        [
            -16.322689735410023,
            28.479292569496977
        ],
        [
            -16.328309316608426,
            28.48008459900113
        ],
        [
            -16.33818337895815,
            28.487657963537544
        ],
        [
            -16.344513056509783,
            28.48788614015332
        ],
        [
            -16.345612050301412,
            28.48911573243207
        ],
        [
            -16.35902012894647,
            28.489251343908364
        ]
    ]
];

const ISLANDS_ROUND_ZONE_POLYGONS: Partial<{ [key in Island]: Partial<{ [key in CardinalPoint]: Coordinates[] }> }> = {
    "TNF": {
        'NORTH': [
            [
                -16.306994170346883,
                28.589521143823944
            ],
            [
                -16.377857590810905,
                28.556062158283705
            ],
            [
                -16.42718977455684,
                28.524462433637396
            ],
            [
                -16.485461257571266,
                28.44909891555585
            ],
            [
                -16.595619009837066,
                28.403882391690424
            ],
            [
                -16.69071053210221,
                28.40657193072628
            ],
            [
                -16.757760716332694,
                28.379656265737715
            ],
            [
                -16.83704896995657,
                28.398832934601177
            ],
            [
                -16.871195224461218,
                28.38192632425269
            ],
            [
                -16.84895382705652,
                28.35990997831705
            ],
            [
                -16.796624624423345,
                28.34720413005489
            ],
            [
                -16.75817550777589,
                28.32826890774352
            ],
            [
                -16.646294780927292,
                28.340120012156483
            ],
            [
                -16.4419763477691,
                28.36647316982176
            ],
            [
                -16.335675469022505,
                28.4481158818991
            ],
            [
                -16.27723010173719,
                28.504194551520627
            ],
            [
                -16.312771161282583,
                28.535820206573355
            ],
            [
                -16.306994170346883,
                28.589521143823944
            ]
        ],
        'WEST': [
            [
                -16.869229831504015,
                28.29073849146434
            ],
            [
                -16.837823079915466,
                28.19423532729177
            ],
            [
                -16.78618529223398,
                28.123558091040163
            ],
            [
                -16.756223603423507,
                28.096383896889506
            ],
            [
                -16.723995706260382,
                28.10595542018263
            ],
            [
                -16.689494814164874,
                28.15199020201453
            ],
            [
                -16.788297231415157,
                28.257267489705754
            ],
            [
                -16.795634171702858,
                28.30386575662267
            ],
            [
                -16.869229831504015,
                28.29073849146434
            ]
        ],
        'SOUTH': [
            [
                -16.75621955703778,
                28.09637917944437
            ],
            [
                -16.742066700758812,
                28.054258141652895
            ],
            [
                -16.692846037187564,
                27.993320995380984
            ],
            [
                -16.54533118844745,
                28.017399036920196
            ],
            [
                -16.42484401535617,
                28.13898712203546
            ],
            [
                -16.39875367834793,
                28.226026232201065
            ],
            [
                -16.45497030746597,
                28.241349899258083
            ],
            [
                -16.568267065418496,
                28.144392031102612
            ],
            [
                -16.64675074774803,
                28.096639552626442
            ],
            [
                -16.70653979485695,
                28.113047850039038
            ],
            [
                -16.72399517613397,
                28.105952027293668
            ],
            [
                -16.75621955703778,
                28.09637917944437
            ]
        ],
    },
    "GC": {
        'NORTH': [
            [
                -15.721606775427375,
                28.170571845742742
            ],
            [
                -15.71435274966666,
                28.08920021723972
            ],
            [
                -15.668726865691525,
                28.075468899543694
            ],
            [
                -15.64463883266427,
                28.12407172066196
            ],
            [
                -15.678456858105989,
                28.174698044715726
            ],
            [
                -15.721606775427375,
                28.170571845742742
            ]
        ],
        'WEST': [
            [
                -15.839120666863579,
                27.921188657258497
            ],
            [
                -15.776619947961308,
                27.818262722476838
            ],
            [
                -15.752100594968311,
                27.808922378008376
            ],
            [
                -15.681194258828043,
                27.896096339932782
            ],
            [
                -15.732478546469451,
                27.94451841955795
            ],
            [
                -15.788774298330381,
                27.939423676147825
            ],
            [
                -15.839120666863579,
                27.921188657258497
            ]
        ],

    }
}

const ISLAND_ZONE_POLYGONS: { [key in Island]: Coordinates[]} = {
    GC: [
        [
            -15.54764784528382,
            28.243044402318034
        ],
        [
            -15.788819240097865,
            28.215948810847365
        ],
        [
            -15.95229783658337,
            27.92173498969356
        ],
        [
            -15.669042842673406,
            27.62958641144938
        ],
        [
            -15.306476450468807,
            27.767165824081474
        ],
        [
            -15.287053250886458,
            28.19883226216855
        ],
        [
            -15.54764784528382,
            28.243044402318034
        ]
    ],
    TNF: [
        [
            -16.727127234800776,
            28.536662159810973
        ],
        [
            -17.036279828153596,
            28.412879181511457
        ],
        [
            -16.84852223219039,
            28.032090903509697
        ],
        [
            -16.64619723654107,
            27.850491586281976
        ],
        [
            -16.30305404391882,
            28.159171171936137
        ],
        [
            -15.912971452305356,
            28.512486086679488
        ],
        [
            -16.150905647190115,
            28.71283732944444
        ],
        [
            -16.727127234800776,
            28.536662159810973
        ]
    ],
    FTV: [
        [
            -13.910123633296507,
            28.820087216389723
        ],
        [
            -14.081695229607647,
            28.76476599207554
        ],
        [
            -14.261359825744336,
            28.355334163559434
        ],
        [
            -14.656298217253209,
            28.070073004752345
        ],
        [
            -14.384373423100016,
            27.977199373193343
        ],
        [
            -13.832430834967056,
            28.16001243954915
        ],
        [
            -13.689994038029027,
            28.800231693105502
        ],
        [
            -13.910123633296507,
            28.820087216389723
        ]
    ],
    LNZ: [
        [
            -13.899551200404971,
            28.836633252525687
        ],
        [
            -13.685896004998853,
            28.81678088395182
        ],
        [
            -13.318473812898901,
            29.063248132902956
        ],
        [
            -13.357320212063655,
            29.482582566618106
        ],
        [
            -13.72312380419848,
            29.479764527586084
        ],
        [
            -13.952964999256693,
            28.917421643187936
        ],
        [
            -13.899551200404971,
            28.836633252525687
        ]
    ],
    LP: [
        [
            -17.865361159927545,
            28.961923852129758
        ],
        [
            -18.14931590097612,
            28.80629271383816
        ],
        [
            -17.906545435347084,
            28.34182127734431
        ],
        [
            -17.66160737627507,
            28.389504724768727
        ],
        [
            -17.62692588118574,
            28.87085099684063
        ],
        [
            -17.865361159927545,
            28.961923852129758
        ]
    ]
}

export async function calculateEstimatePrice(
    parameters: Parameters,
    db: Database
): Promise<{price: number, metadata: {[key: string]: any}}> {
    const {
        serviceType,
        departureDateTime,
        arrivalDateTime = undefined,
        originCoordinates,
        destinationCoordinates,
        pax,
        rate = 1.3,
        vehicleType = undefined,
        kidStroller = 0,
        surfBoard = 0,
        golfBag = 0,
        bike = 0,
        specialLuggage = 0,
        extraLuggage = 0,
    } = parameters;

    if (serviceType == ServiceType.A_DISPOSICION && !arrivalDateTime) {
        console.error("There is no arrivalDateTime and the service is 'A Disposicion'")
        return{price: -1, metadata: {}};
    }

    let priceWith20: number = 0;

    const metadata: { [key: string]: any } = {};

    const island: Island = calculateIslandFromCoordinates(originCoordinates, ISLAND_ZONE_POLYGONS);
    const zoneLevel: ZoneLevel = calculateZoneLevel(originCoordinates, destinationCoordinates, HARD_ZONE_POLYGONS, VERY_HARD_ZONE_POLYGONS);
    const dayTime: DayTime = calculateDayTime(departureDateTime);
    const isLuxury: boolean = calculateIsLuxury(vehicleType);
    const nearestAirport: Airport = await calculateNearestAirport(originCoordinates, island, AIRPORT_COORDINATES, ISLANDS_ROUND_ZONE_POLYGONS, db);

    metadata['island'] = island;
    metadata['zoneLevel'] = zoneLevel;
    metadata['dayTime'] = dayTime;
    metadata['isLuxury'] = isLuxury;
    metadata['nearestAirport'] = nearestAirport;

    console.log(`üëÅÔ∏è Island is ${island} / Zone level is ${zoneLevel} / Day time is ${dayTime} / ${isLuxury ? 'Is luxury' : 'Is not luxury'} / Nearest airport is ${nearestAirport}`)

    if (serviceType == ServiceType.PRIVADO) {

        metadata['serviceType'] = 'Privado';

        const isShuttleZone: boolean = isPointInAnyPolygon(originCoordinates, SHUTTLE_ZONE_POLYGONS) || isPointInAnyPolygon(destinationCoordinates, SHUTTLE_ZONE_POLYGONS);

        metadata['isShuttleZone'] = isShuttleZone;

        let kilometersHours: number = 0;
        const reducedKMH = await calculateReducedKMH(originCoordinates, destinationCoordinates, island, isShuttleZone, db)
        const isReduced: boolean = reducedKMH.isReduced;

        metadata['isReduced'] = isReduced;

        if (isReduced) {
            const routeKilometers = reducedKMH.kilometers;
            const routeHours = reducedKMH.hours;
            kilometersHours = routeKilometers * routeHours;
            console.log(`Is reduced and üöå Kilometers are ${routeKilometers} / Hours are ${routeHours} / KilometersHours are ${kilometersHours}`)

            metadata['routeKilometers'] = routeKilometers;
            metadata['routeHours'] = routeHours;
            metadata['kilometersHours'] = kilometersHours;
        } else {
            const {coordinates: customRoute, roundTrip: roundTrip} = calculateCustomRoute(originCoordinates, destinationCoordinates, island, serviceType, nearestAirport, AIRPORT_COORDINATES, ISLANDS_ROUND_ZONE_POLYGONS);

            metadata['customRoute'] = customRoute;
            metadata['roundTrip'] = roundTrip;
            
            const { kilometers: routeKilometers, hours: routeHours } = await calculateKilometersBetweenPoints(customRoute, db);
            kilometersHours = routeKilometers * routeHours;
            console.log(`Is not reduced and üöå Kilometers are ${routeKilometers} / Hours are ${routeHours} / KilometersHours are ${kilometersHours}`)

            metadata['routeKilometers'] = routeKilometers;
            metadata['routeHours'] = routeHours;
            metadata['kilometersHours'] = kilometersHours;
        }

        priceWith20 = calculateModelPrice(
            zoneLevel,
            pax,
            dayTime,
            island,
            isLuxury,
            kilometersHours,
            nearestAirport,
            isReduced,
            MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA
        )

    } else if (serviceType == ServiceType.A_DISPOSICION && arrivalDateTime) {
        metadata['serviceType'] = 'A Disposicion';
        priceWith20 = calculateAtDisposalPrice(
            pax,
            departureDateTime,
            arrivalDateTime,
            isLuxury,
            island,
            zoneLevel,
            MAX_MICROBUS_PAX_CAPACITY_AT_LA_PALMA
        )
    } else if (serviceType == ServiceType.SHUTTLE) {
        const AIRPORT_TRESHOLD = 500;

        const IS_ORIGIN_AIRPORT = isAirportCloseToCoordinates(originCoordinates, AIRPORT_COORDINATES, AIRPORT_TRESHOLD);
        const IS_DESTINATION_AIRPORT = isAirportCloseToCoordinates(destinationCoordinates, AIRPORT_COORDINATES, AIRPORT_TRESHOLD);
        
        if (IS_ORIGIN_AIRPORT || IS_DESTINATION_AIRPORT) {
            metadata['serviceType'] = 'Shuttle';

            console.log(`üõ´ Is SHUTTLE and ${IS_ORIGIN_AIRPORT ? 'origin' : 'destination'} is airport ${IS_ORIGIN_AIRPORT ? IS_ORIGIN_AIRPORT : IS_DESTINATION_AIRPORT}`)

            const ISLAND_PLACES = await getIslandsPlacesForShuttle();
            const isShuttlePoint = isPlaceSuitableForShuttle(IS_ORIGIN_AIRPORT ? destinationCoordinates : originCoordinates, ISLAND_PLACES[island]);
            if (isShuttlePoint) {

                metadata['isShuttlePoint'] = isShuttlePoint;

                console.log(`üè® Is Shuttle point`)

                const AIRPORT_PRICES = await getAirportsPricesForShuttle();
                const shuttlePaxPrice = AIRPORT_PRICES[nearestAirport][isShuttlePoint];
                if (shuttlePaxPrice.price) {
                    priceWith20 = shuttlePaxPrice.price * pax;
                }
            }
        }
        console.log('Is not shuttle...')
    }

    // TODO: Modify this to calculate the price of luggage with shuttle on the function calculatePriceLuggage
    let priceWithRate = serviceType != ServiceType.SHUTTLE ? (priceWith20 / 1.2) * rate : priceWith20;
    // TODO: Modify this to calculate the price of luggage with shuttle on the function calculatePriceLuggage
    let extraLuggagePrice = serviceType != ServiceType.SHUTTLE ? calculatePriceLuggage(
        pax,
        isLuxury,
        (kidStroller + surfBoard + golfBag + bike + specialLuggage),
        extraLuggage,
        originCoordinates,
        destinationCoordinates,
        LUGGAGE_ZONE_POLYGONS) : 0;

    console.log(`üí∞ Price with rate is ${priceWithRate} and extra luggage price is ${extraLuggage}`)

    metadata['priceWithRate'] = priceWithRate;
    metadata['extraLuggagePrice'] = extraLuggagePrice;

    // TODO: Add Taxes

    return {price: priceWithRate + extraLuggagePrice, metadata: metadata};
}